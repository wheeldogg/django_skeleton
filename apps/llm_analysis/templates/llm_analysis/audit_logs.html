{% extends 'base.html' %}

{% block title %}Audit Logs - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="min-w-0 flex-1">
            <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
                Prompt Audit Logs
            </h1>
            <p class="mt-1 text-sm text-gray-500">
                Security audit trail for all LLM prompts
            </p>
        </div>
        <div class="mt-4 flex md:ml-4 md:mt-0 space-x-2">
            <!-- Connection Check -->
            <button hx-post="{% url 'llm_analysis:check-connection' %}"
                    hx-target="#connection-status"
                    hx-indicator="#connection-loading"
                    class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <span id="connection-loading" class="htmx-indicator">
                    <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </span>
                Check Bedrock
                <span id="connection-status" class="ml-2"></span>
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white shadow rounded-lg p-4">
        <div class="flex items-center space-x-4">
            <span class="text-sm font-medium text-gray-700">Filter:</span>
            <a href="{% url 'llm_analysis:audit-logs' %}"
               class="px-3 py-1 rounded-full text-sm {% if not filter_blocked %}bg-indigo-100 text-indigo-700{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                All
            </a>
            <a href="{% url 'llm_analysis:audit-logs' %}?blocked=true"
               class="px-3 py-1 rounded-full text-sm {% if filter_blocked == 'true' %}bg-red-100 text-red-700{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Blocked
            </a>
            <a href="{% url 'llm_analysis:audit-logs' %}?blocked=false"
               class="px-3 py-1 rounded-full text-sm {% if filter_blocked == 'false' %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Allowed
            </a>
        </div>
    </div>

    <!-- Logs Table -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Time
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        User
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Prompt
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Mode
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Response
                    </th>
                    <th scope="col" class="relative px-6 py-3">
                        <span class="sr-only">View</span>
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for log in logs %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ log.created_at|date:"M d H:i" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">
                            {% if log.user %}{{ log.user.username }}{% else %}Anonymous{% endif %}
                        </div>
                        <div class="text-xs text-gray-500">{{ log.ip_address|default:"-" }}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 max-w-xs truncate" title="{{ log.prompt }}">
                            {{ log.prompt_preview }}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ log.get_mode_display }}
                        {% if log.bypass_used %}
                        <span class="ml-1 text-yellow-600" title="Guardrails bypassed">&#9888;</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if log.was_filtered %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            Blocked
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            OK
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if log.response_time_ms %}
                            {{ log.response_time_ms }}ms
                            <span class="text-xs">({{ log.input_tokens|default:0 }}/{{ log.output_tokens|default:0 }})</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <a href="{% url 'llm_analysis:audit-log-detail' log.id %}"
                           class="text-indigo-600 hover:text-indigo-900">
                            View
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-sm text-gray-500">
                        No audit logs found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
